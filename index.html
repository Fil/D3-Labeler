<!DOCTYPE html>
<meta charset="utf-8">
<style>

body {
  font: 10px sans-serif;
}

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.dot {
  stroke: #000;
}

.circ {
  stroke: #000;
}

.rect {
  stroke: #000;
}

.axis_label {
  font: 10px sans-serif;
}

.label {
  font: 10px sans-serif;
}

.link { stroke:gray;stroke-width:0.5}

</style>
<body>

<button type="button" id="randomize1">Start annealing</button>
<!--
<button type="button" id="randomize1">Replace with 20</button>
<button type="button" id="randomize2">Replace with 40</button>
<button type="button" id="scatter_plot">Scatter plot</button>
<button type="button" id="line_plot">Line plot</button>
-->

<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="anneal.js"></script>
<script>

    var anchor = [],
        label_centers = [],
        label_bounds = [],
        margin = {top: 20, right: 20, bottom: 30, left: 10},
        width = 450 - margin.left - margin.right,
        height = 300 - margin.top - margin.bottom,
        x_mean = width/2,
        x_std = width/4,
        y_mean = height/2,
        y_std = height/4,
        offset = 4;

    var anchor_data, labels, circ, links, bounds;

    var svg = d3.select("body").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    // Functions
    function redrawLabels() {
        labels
        .transition()
        .duration(1000)
        .attr("x", function(d) { return (d.x); })
        .attr("y", function(d) { return (d.y); });

        links
        .transition()
        .duration(1000)
        .attr("x2",function(d) { return (d.x); })
        .attr("y2",function(d) { return (d.y); });

        circ
        .transition()
        .duration(1000)
        .attr("cx",function(d) { return (d.x); })
        .attr("cy",function(d) { return (d.y - offset); });

        bounds
        .transition()
        .duration(1000)
        .attr("x",function(d) { return (d.x); })
        .attr("y",function(d) { return (d.y - 10); });

    }

    function randomize(count) {
        anchor = [];
        label_centers = [];
        label_bounds = [];

        for (var i = 0; i < count; i++) {
            var xval=x_mean + (2 * Math.random() - 1.0) * x_std * 1.5;
            // var yval=y_mean + (2 * Math.random() - 1.0) * y_std * 1.5;
            var yval=y_mean;
            anchor.push({x: xval, y: yval, name: "Node "+String(i)});
            label_centers.push({x: xval, y: yval+1.0, name: "Node "+String(i), width: 0.0, height: 0.0});
        }

        // Delete old stuff
        svg.selectAll(".dot").data([]).exit().remove();
        svg.selectAll(".label").data([]).exit().remove();
        svg.selectAll(".circ").data([]).exit().remove();
        svg.selectAll(".link").data([]).exit().remove();
        svg.selectAll(".rect").data([]).exit().remove();

        // Draw anchors
        anchor_data = svg.selectAll(".dot")
            .data(anchor)
            .enter().append("circle")
            .attr("class", "dot")
            .attr("r", 4.0)
            .attr("cx", function(d) { return (d.x); })
            .attr("cy", function(d) { return (d.y); })
            .style("fill", 'red');

        // Draw labels
        labels = svg.selectAll(".label")
            .data(label_centers)
            .enter()
            .append("text")
            .attr("class", "label")
            .attr('text-anchor', 'start')
            .text(function(d) { return d.name; })
            .attr("x", function(d) { return (d.x); })
            .attr("y", function(d) { return (d.y); })
            .attr("fill", "black");

        // Size of each label
        
        labels.each(function() {
            console.log(this.getBBox());
            label_bounds.push(this.getBBox());
        });



        for (var i = 0; i < count; i++) {
            label_centers[i].width = label_bounds[i].width;
            label_centers[i].height = label_bounds[i].height;
        }

        // Draw label boundaries
        bounds = svg.selectAll(".rect")
            .data(label_centers)
            .enter().append("rect")
            .attr("class", ".rect")
            .attr("x", function(d) { return (d.x); })
            .attr("y", function(d) { return (d.y); })
            .attr("width", function(d) { return (d.width); })
            .attr("height", function(d) { return (d.height); })
            .style("fill", 'white')
            .style("fill-opacity", '0.0')
            .style("stroke", "black")
            .style("stroke-opacity", "1.0");

        // Draw data points
        circ = svg.selectAll(".circ")
            .data(label_centers)
            .enter().append("circle")
            .attr("class", ".circ")
            .attr("r", 20.0)
            .attr("cx", function(d) { return (d.x); })
            .attr("cy", function(d) { return (d.y - offset); })
            .style("fill", 'red')
            .attr('opacity',0.0);

        // Draw links
        links = svg.selectAll(".link")
            .data(label_centers)
            .enter()
            .append("line")
            .attr("class", "link")
            .attr("x1", function(d) { return (d.x); })
            .attr("y1", function(d) { return (d.y); })
            .attr("x2", function(d) { return (d.x); })
            .attr("y2", function(d) { return (d.y); })
            .attr("stroke-width", 0.5)
            .attr("stroke", "gray");

        // Implement simulated annealing
        
        redrawLabels();
    };

    // Demonstration examples
    d3.select("#randomize1").on("click",function() {
        randomize(40)
        var sim_ann = d3.anneal()
            .nodes(label_centers)
            .anchor(anchor)
            .width(width).height(height)
            .sim_anneal(0.0001);
        redrawLabels();
        });

    d3.select("#randomize2").on("click",function() {
        randomize(40)
        var sim_ann = d3.anneal()
            .nodes(label_centers)
            .anchor(anchor)
            .width(width).height(height)
            .sim_anneal(0.25);
        redrawLabels();
        });
    
    randomize(40);
    var sim_ann = d3.anneal()
            .nodes(label_centers)
            .anchor(anchor)
            .width(width).height(height)
            .sim_anneal(0.05);
        redrawLabels();

</script>